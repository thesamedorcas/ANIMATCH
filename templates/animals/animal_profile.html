{% extends 'animals/base.html' %}
{% load static %}
{% block title_block %}
{{ animal.name }} - Animal Profile
{% endblock %}

{% block body_block %}
<div class = "animal-profile-container">
    <h1>{{ animal.name }}</h1>
    <div class="animal-profile">
        <div class="animal-profile-image">
        {% if animal.picture %}
            <img class="animal-photo" src="{{ animal.picture.url }}" alt="{{ animal.name }}">
        {% else %}
            <img class="animal-photo" src="{% static 'images/default-animal.jpg' %}" alt="{{ animal.name }}">
        {% endif %}
        </div>

    <div class="animal-profile-details">
        <p>Name: {{ animal.name }}</p>
        <p>Species: {{ animal.species }}</p>
        <p>Breed: {{ animal.breed }}</p>
        <p>Age: {{ animal.age }}</p>
        <p>Sex: {{ animal.sex }}</p>
        <p>About: {{ animal.about }}</p>
        <p>Sociable: {% if animal.sociable %}Yes{% else %}No{% endif %}</p>
        <p><strong>Status:</strong> {% if animal.adopted %}Adopted{% else %}Available for adoption{% endif %}</p>
            
        <div class="animal-about">
            <h3>About</h3>
            <p>{{ animal.about }}</p>
        </div>
        
        {% if user.is_authenticated %}
            {% if not animal.adopted and user != animal.owner %}
            <div class="action-buttons">
            {% if existing_request %}
                <div class="existing-request">
                    <h3>Your Adoption Request</h3>
                    <p>Status: 
                        <span class="status-{{ existing_request.status|lower }}">
                            {{ existing_request.status }}
                        </span>
                    </p>
                    <p>Submitted on: {{ existing_request.date_submitted|date:"F j, Y" }}</p>
                    {% if existing_request.status == 'pending' %}
                        <p>Your request is being reviewed by the owner.</p>
                    {% elif existing_request.status == 'approved' %}
                        <p>Congratulations! Your request has been approved.</p>
                    {% elif existing_request.status == 'rejected' %}
                        <p>Unfortunately, your request was not approved.</p>
                    {% endif %}
                </div>
            {% else %}
                <button id="adopt-button" class="btn btn-primary">Request to Adopt</button>

            
            <div id="adoption-form" class="adoption-form" style="display: none;">
                <h3>Adoption Request</h3>
                <form method="post" action="{% url 'animals:request_adoption' animal.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="id_message">Why do you want to adopt {{ animal.name }}?</label>
                        <textarea name="message" id="id_message" class="form-control" rows="4" required></textarea>
                        <small class="form-text text-muted">Please tell us why you would like to adopt this animal and your experience with pets.</small>
                    </div>
                    <div class="form-group">
                        <label for="id_contact_phone">Contact Phone (Optional)</label>
                        <input type="text" name="contact_phone" id="id_contact_phone" class="form-control">
                        <small class="form-text text-muted">Provide a phone number where we can reach you.</small>
                    </div>
                    <button type="submit" class="btn btn-success">Submit Request</button>
                    <button type="button" id="cancel-adoption" class="btn btn-secondary">Cancel</button>
                </form>
            </div>
        {% endif %}                
                {% if is_favourite %}
                    <form method="post" action="{% url 'animals:remove_favourite' animal.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-secondary">Remove from Favourites</button>
                    </form>
                {% else %}
                    <form method="post" action="{% url 'animals:add_favourite' animal.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-secondary">Add to Favourites</button>
                    </form>
                {% endif %}
            </div>
            
            {% endif %}
        {% if user == animal.owner %}
        <div class="owner-actions">
                        <h3>Owner Actions</h3>
                        <h3>{% if user == animal.owner %}Owner{% else %}Admin{% endif %} Actions</h3>
                        <button id="edit-button" class="btn btn-primary">Edit Details</button>

                        {% if animal.picture %}
                            <form method="post" action="{% url 'animals:remove_photo' animal.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">Remove Photo</button>
                            </form>
                        {% endif %}
                        
                        {% if not animal.adopted %}
                            <form method="post" action="{% url 'animals:mark_adopted' animal.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">Mark as Adopted</button>
                            </form>
                        {% else %}
                            <form method="post" action="{% url 'animals:mark_available' animal.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning">Mark as Available</button>
                            </form>
                        {% endif %}
                        <!--adding delete button-->
                        <form method="post" action="{% url 'animals:delete_animal' animal.id %}" class="d-inline" 
                              onsubmit="return confirm('Are you sure you want to delete this animal? You cannot undo this action.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Delete Animal</button>
                        </form>
                    </div>
                    
                    <div id="edit-form" class="edit-form" style="display: none;">
                        <h3>Edit {{ animal.name }}'s Details</h3>
                        <form method="post" action="{% url 'animals:edit_animal' animal.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="name">Name:</label>
                                <input type="text" id="name" name="name" value="{{ animal.name }}" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="species">Species:</label>
                                <select id="species" name="species" class="form-control" required>
                                    {% for choice in species_choices %}
                                        <option value="{{ choice.0 }}" {% if animal.species == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="breed">Breed:</label>
                                <input type="text" id="breed" name="breed" value="{{ animal.breed }}" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="age">Age:</label>
                                <input type="number" id="age" name="age" value="{{ animal.age }}" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="sex">Sex:</label>
                                <select id="sex" name="sex" class="form-control" required>
                                    {% for choice in sex_choices %}
                                        <option value="{{ choice.0 }}" {% if animal.sex == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="about">About:</label>
                                <textarea id="about" name="about" class="form-control" rows="4" required>{{ animal.about }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="picture">Picture:</label>
                                <input type="file" id="picture" name="picture" class="form-control-file">
                                {% if animal.picture %}
                                    <p class="mt-1">Current: {{ animal.picture.url }}</p>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="sociable">Sociable:</label>
                                <select id="sociable" name="sociable" class="form-control">
                                    <option value="True" {% if animal.sociable %}selected{% endif %}>Yes</option>
                                    <option value="False" {% if not animal.sociable %}selected{% endif %}>No</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Save Changes</button>
                            <button type="button" id="cancel-edit" class="btn btn-secondary">Cancel</button>
                        </form>
                    </div>
                {% endif %}
            {% else %}
                <p class="login-prompt">Please <a href="{% url 'animals:login' %}">login</a> to request adoption or save to favourites.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // JavaScript (I'm not a fan of this language but sure)
    document.addEventListener('DOMContentLoaded', function() {
    
        const adoptButton = document.getElementById('adopt-button');
        const adoptionForm = document.getElementById('adoption-form');
        const cancelAdoption = document.getElementById('cancel-adoption');
        
        if (adoptButton) {
            adoptButton.addEventListener('click', function() {
                adoptionForm.style.display = 'block';
                adoptButton.style.display = 'none';
            });
        }
        
        if (cancelAdoption) {
            cancelAdoption.addEventListener('click', function() {
                adoptionForm.style.display = 'none';
                adoptButton.style.display = 'inline-block';
            });
        }
        
        // Edit form 
        const editButton = document.getElementById('edit-button');
        const editForm = document.getElementById('edit-form');
        const cancelEdit = document.getElementById('cancel-edit');
        
        if (editButton) {
            editButton.addEventListener('click', function() {
                editForm.style.display = 'block';
                editButton.style.display = 'none';
            });
        }
        
        if (cancelEdit) {
            cancelEdit.addEventListener('click', function() {
                editForm.style.display = 'none';
                editButton.style.display = 'inline-block';
            });
        }
    });
</script>

{% endblock %}